/**
* Cores Na Prateleira
* @author Carlos Vinicius
* @version 6.0 [em desenvolvimento]
* @date 2011-10-22
*
* A opção de buscar as informação em uma página de produto alternativa ainda esta em BETA
*
* Chave debug para URL: debugcp
*/
"function"!==typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});
jQuery.fn.coresPrateleira=function(w){var u,b,n,p,s,q;u=jQuery("");q=/http\:\/\/[a-z\-\.]+(?=\/)/i;s=-1<document.location.href.toLowerCase().indexOf("debugcp");n=function(a,b){"object"==typeof console&&console.log("[Cores Prateleira - "+(b||"Erro")+"] "+a)};p=function(a,b){"object"==typeof console&&s&&console.log("[debug][Cores Prateleira - "+(b||"Erro")+"] "+a)};b={loadSkuJqxhr:null,productOriginalInfo:null,productOriginalLink:null,productOriginalSave:null,saveCount:0,onHover:!1,skuList:[],skuQueue:[],
productSkus:{},skuGroup:{},skuProduct:{},productHtml:{},productShelf:null,options:{productsLi:">ul li",messageRequestFail:"N\u00e3o foi posss\u00edvel obter as informa\u00e7\u00f5es deste item.",saveText:"Economize: R$ #value",currency:"R$ ",productPageUrl:"/cores-prateleira",restoreOriginalDetails:!1,checkLinkEquals:!1,forceAvailable:!1,forceImgList:!1,autoSetup:!0,checkIsAvaliable:!1,useProductField:!1,checkDuplicateUri:!0,speedFade:200,thumbsQuantity:4,minSkuQttShow:2,productImgId:30,thumbImgId:3,
action:2,ajaxCallback:function(){},callback:function(){},thumbRendered:function(){}},init:function(a){jQuery.extend(b.options,a);b.createSkuElementsList();b.options.callback()},createSkuElementsList:function(){var a=b.productShelf;0<a.length&&a.each(function(a){var c=jQuery(this);c.hasClass("vtex-cpIsActivated")||(v=b.exec(c,a))})},exec:function(a,d){var c=a.find(b.options.productsLi);if(1>c.length)return n("Prateleira n\u00e3o encontrada \n ("+c.selector+")"),!1;a.addClass("vtex-cpIsActivated");
c.each(function(a){var c,g,h,i,l,k,j,m,r;c=jQuery(this);!0===b.options.autoSetup&&b.shelfSetup(c);g=c.find(".vtex-cpSkuList");h=c.find(".vtex-cpProductField");l=d.toString()+"_"+a.toString();m=function(a){var d;i=b.groupSku(a,l);c.find(".vtex-cpProductImage img").addClass("vtex-cpOriginalImage");skuArrayLength=i.length;(b.options.forceAvailable||b.options.forceImgList)&&g.addClass("vtex-cpShow").removeClass("vtex-cpHide");if(skuArrayLength>=b.options.minSkuQttShow)for(var e=0;e<skuArrayLength;e++){var h,
j;h=i[e][1];j=i[e][0].trim();a=j.replace(q,"");if(b.options.checkLinkEquals&&(k=a==(c.find(".vtex-cpProductLink:first").attr("href")||"").trim().replace(q,""))){p("O sku \u201c"+h+"\u201d foi ignorado pois tem o mesmo link que o produto existente na vitrine.\n URI: "+a,"Aviso");continue}if(b.options.checkDuplicateUri&&0<c.find(".vtex-cpSkuIds[ref='"+a+"']").length)p("O sku \u201c"+h+"\u201d foi ignorado pois j\u00e1 existe uma thumb na vitrine com o mesmo link.\n URI: "+a,"Aviso");else if(d=c.data("vtex-cp_skusCount"),
"undefined"==typeof d?c.data("vtex-cp_skusCount",d=0):c.data("vtex-cp_skusCount",d+1),d>=b.options.thumbsQuantity){c.find(".vtex-cpViewMore").addClass("vtex-cpShow").removeClass("vtex-cpHide");break}else""!==h&&!(skuArrayLength>b.options.thumbsQuantity&&d>=b.options.thumbsQuantity-1)&&(d=jQuery("<span class='vtex-cpSkuIds vtex-cpIndex_"+d+" vtex-cpSkuId_"+h+" vtex-cpHide'><span class='vtex-cpInner'></span><span class='vtex-cpInner2'></span></span>"),d.attr({ref:a,id:h}),g.append(b.setThumbs(c,h,d,
j,l)))}r=c.find(".vtex-cpSkuIds");r.length>=b.options.minSkuQttShow&&r.removeClass("vtex-cpHide");r.first().addClass("vtex-cpFirst")};b.options.useProductField?(a=h.find("li").text().trim().split("|"),s&&""===h.find("li").text().trim()&&p("O campo produto n\u00e3o esta retornando nenhum valor.\n Produto: "+(c.find(".vtex-cpProductLink[title]:first").attr("title")||"[T\u00edtulo n\u00e3o encontrado]"),"Aviso"),m(a)):(j=c.find(".vtex-cpProdId").val(),h=c.find(".vtex-cpUri").val(),"undefined"===typeof j&&
n("N\u00e3o foi poss\u00edvel obter o ID do produto no campo \u201cvtex-cpProdId\u201d."),"undefined"===typeof h&&n("N\u00e3o foi poss\u00edvel obter a URL do produto no campo \u201cvtex-cpUri\u201d."),b.getProductInfo(function(a){m(a,j)},j,h))})},getProductInfo:function(a,d,c,e,f,g,h){var i,l,k,j=[],m,r,p=[],q=!0,e="undefined"==typeof e?!1:e;jQuery.ajax({url:b.options.productPageUrl+"?idproduto="+d,success:function(t){if(-1<t.indexOf("Ocorreu um erro"))return n("Erro ao tentar obter os dados na p\u00e1gina de produto espec\u00edfica do plugin. Uri utilizada:"),
!1;i=jQuery(t);l=!1;k=null;b.productHtml[d]=i;i.filter("script:not([src])").each(function(){var a;a=this.innerHTML;if(-1<a.indexOf("myJSONSkuSpecification"))return a=a.replace(":,",':"",').replace(":}",':""}').replace(":]",':""]'),eval(a),k=myJSONSkuSpecification,l=!0,!1});if(!l)return n("N\u00e3o foi poss\u00edvel localizar as especifica\u00e7\u00f5es do SKU. Id produto: "+d);r=k.skus.length;for(m=0;m<r;m++)for(var s in k.skus[m])t=k.skus[m][s].split(",").shift(),j.push(t+";"+c),b.skuProduct[t]=
d;b.productSkus[d]=j;f=f||[];p=jQuery.merge(f,j);"undefined"!=typeof h&&h.addClass("checked");e||i.find(".vtex-cpRelated").each(function(){var c,d;c=b.getRelatedProductInfo($(this));d=c.pop();c.length&&(q=!1,b.getProductInfo(a,c[0],c[1],!0,p,i,d))});e&&g.find(".vtex-cpRelated.checked").length>=g.find(".vtex-cpRelated").length?(debugCallType="Recursive [stop]",a(p,debugCallType)):q&&"undefined"==typeof g&&(debugCallType="Direct [exit]",a(j,debugCallType))},error:function(){n("Erro ao tentar obter os dados na p\u00e1gina de produto espec\u00edfica do plugin. Uri utilizada:")}})},
getRelatedProductInfo:function(a){var b,c,e=[a];b=a.find(".vtex-cpProdId").val();c=a.find(".vtex-cpUri").val();"undefined"!==typeof b&&"undefined"!==typeof c&&(e=[b,c,a]);return e},groupSku:function(a,d){var c={},e={},f=[],g,h,i;i=a.length;if(2>i&&""===a[0])return f;for(var l=0;l<i;l++)g=a[l].split(";"),h=g.pop(),g=g.shift(),"undefined"!=typeof h&&("undefined"==typeof c[g]?c[g]=[h]:c[g].push(h));for(var k in c){i=c[k].length;tmp2=[];if(3<i){var j;h=parseInt(i/3,10);g=i%3;j=2*h;for(l=0;l<h;l++)tmp2.push(c[k][l]),
tmp2.push(c[k][l+h]),tmp2.push(c[k][l+j]);1==g?tmp2.push(c[k][i-1]):2==g&&(tmp2.push(c[k][i-1]),tmp2.push(c[k][i-2]))}else tmp2=c[k];f.push([tmp2.shift(),k]);e[k]=tmp2}b.skuGroup[d]=e;return f},setThumbs:function(a,d,c,e,f){var g=a.find(".vtex-cpOverlay");c.addClass("vtex-cpLoadingData");b.loadSku(a,d,g,b.options.action,c,e,f);b.options.thumbRendered(a,c,b.productHtml,b.skuProduct,d);return c},checkIsAvaliable:function(a,d,c,e,f,g){if(e[0].Availability||!b.options.checkIsAvaliable)b.mouseActions2(a,
d,c,e,f);else{var h=a.find(".vtex-cpOverlay");"undefined"!=typeof b.skuGroup[g][f]&&0<b.skuGroup[g][f].length?b.loadSku(a,b.skuGroup[g][f].shift(),h,b.options.action,c,f,g):b.mouseActions2(a,d,c,e,f)}},mouseActions2:function(a,d,c,e,f){b.setImgThumb(c,e);b.setClass(c,e);c.bind({mouseenter:function(){a.find(".vtex_cpActiveSku").removeClass("vtex_cpActiveSku");c.addClass("vtex_cpActiveSku");b.productOriginalInfo=a.find(".vtex-cpProductInfoWrap").children().clone();b.productOriginalLink=a.find(".vtex-cpProductLink:first").attr("href")||
"";var d=a.find(".vtex-cpSave");b.productOriginalSave=[d.html()||"",d.attr("class")||""];b.formatInfo(e,a,f);b.onHover=!0}});b.options.restoreOriginalDetails&&c.bind({mouseleave:function(){a.find(".vtex_cpActiveSku").removeClass("vtex_cpActiveSku");b.setOriginalElements(a);b.onHover=!1}});return c},mouseActions:function(a,d,c){c.bind({mouseenter:function(){a.find(".vtex_cpActiveSku").removeClass("vtex_cpActiveSku");c.addClass("vtex_cpActiveSku");var e=a.find(".vtex-cpOverlay").show();b.loadSku(a,
d,e);b.productOriginalInfo=a.find(".vtex-cpProductInfoWrap").children().clone();b.onHover=!0},mouseleave:function(){a.find(".vtex_cpActiveSku").removeClass("vtex_cpActiveSku");a.find(".vtex-cpOverlay").hide();b.loadSkuJqxhr.abort();b.setOriginalElements(a);b.onHover=!1}});return c},formatInfo:function(a,d,c){d.addClass("vtex-cpInfoFromSKU");var e=a[0];if(e.Availability||b.options.forceAvailable)if(a=d.find(".vtex-cpProductInfo"),a.addClass("vtex-cpShow").removeClass("vtex-cpHide"),d.find(".vtex-cpProductUnavailable").addClass("vtex-cpHide").removeClass("vtex-cpShow"),
a.find(".vtex-cpBestPrice").text(b.options.currency+b.numberFormat(e.Price)),d.find(".vtex-cpSave").html(b.options.saveText.replace("#value",b.numberFormat(e.ListPrice-e.Price))),e.Price<e.ListPrice?(a.find(".vtex-cpListPriceWrap").addClass("vtex-cpShow").removeClass("vtex-cpHide").find(".vtex-cpListPrice").text(b.options.currency+b.numberFormat(e.ListPrice)),d.find(".vtex-cpSave").addClass("vtex-cpShow").removeClass("vtex-cpHide")):(a.find(".vtex-cpListPriceWrap").addClass("vtex-cpHide").removeClass("vtex-cpShow"),
d.find(".vtex-cpSave").addClass("vtex-cpHide").removeClass("vtex-cpShow")),1<e.BestInstallmentNumber){var f=a.find(".vtex-cpInstallment").addClass("vtex-cpShow").removeClass("vtex-cpHide");f.find(".vtex-cpNumbersOfInstallment").text(e.BestInstallmentNumber);f.find(".vtex-cpInstallmentValue").text(b.options.currency+b.numberFormat(e.BestInstallmentValue));a.find(".vtex-cpFullRegularPrice").addClass("vtex-cpHide").removeClass("vtex-cpShow")}else a.find(".vtex-cpInstallment").addClass("vtex-cpHide").removeClass("vtex-cpShow"),
a.find(".vtex-cpFullRegularPrice").addClass("vtex-cpShow").removeClass("vtex-cpHide");else d.find(".vtex-cpProductInfo").addClass("vtex-cpHide").removeClass("vtex-cpShow"),d.find(".vtex-cpProductUnavailable").addClass("vtex-cpShow").removeClass("vtex-cpHide");var a=d.find(".vtex-cpProductImage"),g=d.find(".vtex-cpImgOverlay"),h=a.find(".vtex-cpOriginalImage"),i=h[0],l=h.clone(),f=l.attr("width")||i.naturalWidth,i=l.attr("height")||i.naturalHeight,e=b.getImageUrl(e,b.options.productImgId),l=d.find("img[src*='"+
(e[0]||h.attr("src"))+"']"),k=0<l.length?!0:!1,j=jQuery('<img src="'+(e[0]||h.attr("src"))+'" alt="" '+("undefined"!==typeof f?'width="'+f+'"':"")+" "+("undefined"!==typeof i?'height="'+i+'"':"")+' class="vtex-cpSkuImage" style="display:none;" />');""!==c&&d.find(".vtex-cpProductLink").attr("href",c.replace(q,""));g.show();k?(h.stop(!0).fadeOut(b.options.speedFade),g.hide(),d.find(".vtex-cpSkuImage").stop(!0).fadeOut(b.options.speedFade),l.stop(!0).fadeTo(b.options.speedFade,1)):(j.load(function(){b.onHover?
(h.stop(!0).fadeOut(b.options.speedFade),g.hide(),d.find(".vtex-cpSkuImage").stop(!0).fadeOut(b.options.speedFade),j.stop(!0).fadeTo(b.options.speedFade,1)):(g.hide(),b.setOriginalImg(d))}),a.append(j))},setOriginalElements:function(a){null!==b.productOriginalInfo&&a.hasClass("vtex-cpInfoFromSKU")&&(a.removeClass("vtex-cpInfoFromSKU").find(".vtex-cpProductInfoWrap").html(b.productOriginalInfo),b.setOriginalImg(a),b.setOriginalLink(a),b.setOriginalSaveText(a))},setOriginalImg:function(a){a=a.find(".vtex-cpProductImage");
a.find(":not(.vtex-cpOriginalImage)").stop(!0).fadeOut(b.options.speedFade);a.find(".vtex-cpOriginalImage").stop(!0).fadeTo(b.options.speedFade,1)},setOriginalLink:function(a){a.find(".vtex-cpProductLink").attr("href",b.productOriginalLink)},setOriginalSaveText:function(a){a.find(".vtex-cpSave").html(b.productOriginalSave[0]).attr("class",b.productOriginalSave[1])},setImgThumb:function(a,d){var c=b.getImageUrl(d[0],b.options.thumbImgId);a.removeClass("vtex-cpLoadingData");0<c.length&&(a.css("background-image",
"url('"+c[0]+"')"),a.find(".vtex-cpInner").append('<img src="'+c[0]+'" alt="" class="vtex-cpImgsThumb vtex-cpThumb_'+d[0].Id+'" alt=""/>'))},loadSku:function(a,d,c,e,f,g,h){var e=e||1,f=f||u,d=d.toString().trim(),i=d.toString();"undefined"!==typeof b.skuQueue[i]?b.skuQueue[i].push({liElem:a,skuId:d,span:f,link:g}):(b.skuQueue[i]=[],b.loadSkuJqxhr=jQuery.ajax({url:"/produto/sku/"+d,data:"json",success:function(c,k,j){if("object"!==typeof c)return n(b.options.messageRequestFail+"\n skuId: "+d+"\n(textStatus:'"+
k+"', jqXHR:'"+j+"')"),f.hide(),!1;if(0!==j.status){b.skuQueue[i].push({liElem:a,skuId:d,span:f,link:g});for(var k=b.skuQueue[i].length,j=b.skuQueue[i],m=0;m<k;m++)switch(e){case 1:b.formatInfo(c,j[m].liElem);break;case 2:b.checkIsAvaliable(j[m].liElem,j[m].skuId,j[m].span,c,j[m].link,h)}b.skuQueue[i]=void 0;b.options.ajaxCallback()}},error:function(a,c,e){n(b.options.messageRequestFail+"\n skuId: "+d+"\n(textStatus:'"+c+"', jqXHR:'"+a+"', errorThrown:'"+e+"')");f.hide()}}))},numberFormat:function(a){for(var b=
"",c=b="",a=a.toFixed(2).split("."),e=0,f=a[0].split("").length,g=a[0].length;0<g;g--)b=a[0].substr(g-1,1),e++,0===e%3&&f>e&&(b="."+b),c=b+c;return b=c+","+a[1]},getImageUrl:function(a,b){var c=[];if(1>a.Images.length)return n("N\u00e3o foram encontradas imagens para o SKU: "+a.Id),c;for(var e in a.Images)for(var f in a.Images[e])if(a.Images[e][f].ArchiveTypeId==b){c.push(a.Images[e][f].Path);break}return c},setClass:function(a,b){var c=b[0].Name.replace(/[^a-zA-Z0-9\-\_]/g,"");a.addClass("vtex-cp_"+
c)},shelfSetup:function(a){a.find("a[href='"+a.find(".vtex-cpUri").val()+"']").addClass("vtex-cpProductLink");var d=null;a.find("img").each(function(){var a=jQuery(this);d=null===d?a:d;if(0<(a.attr("width")||0))d=a});d.before('<div class="vtex-cpImgOverlay"></div>');d.parent().addClass("vtex-cpProductImage");var c=jQuery('<span class="vtex-cpProductTextWrap"><div class="vtex-cpOverlay"></div></span>'),e=jQuery('<span class="vtex-cpProductInfoWrap"></span>'),f=a.find(".vtex-cpProductInfo");f.before(c);
f.appendTo(e);a.find(".vtex-cpProductUnavailable").appendTo(e);e.appendTo(c);1>b.saveCount&&(c=/\sR\$\s[0-9]+,[0-9]{1,2}/i,a=a.find(".vtex-cpSave").text(),-1<a.search(c)&&(b.options.saveText=a.replace(c," R$ #value")),b.saveCount++)}};b.productShelf=jQuery(this);b.init(w);return b.productShelf};